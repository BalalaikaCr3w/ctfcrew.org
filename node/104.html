<!DOCTYPE html>
<!--[if lt IE 7]> <html class="ie6 ie" lang="en" dir="ltr"> <![endif]-->
<!--[if IE 7]>    <html class="ie7 ie" lang="en" dir="ltr"> <![endif]-->
<!--[if IE 8]>    <html class="ie8 ie" lang="en" dir="ltr"> <![endif]-->
<!--[if IE 9]>    <html class="ie9 ie" lang="en" dir="ltr"> <![endif]-->
<!--[if !IE]> --> <html lang="en" dir="ltr"> <!-- <![endif]-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/all/themes/open_framework/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="104.html" />
<link rel="canonical" href="../writeup/104.html" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Isomni&#039;hack 2017 teaser mindreader writeup | BalalaikaCr3w</title>
  <style type="text/css" media="all">
@import url("https://ctfcrew.org/modules/system/system.base.css?qtecp0");
@import url("https://ctfcrew.org/modules/system/system.menus.css?qtecp0");
@import url("https://ctfcrew.org/modules/system/system.messages.css?qtecp0");
@import url("https://ctfcrew.org/modules/system/system.theme.css?qtecp0");
</style>
<style type="text/css" media="all">
@import url("https://ctfcrew.org/modules/comment/comment.css?qtecp0");
@import url("https://ctfcrew.org/modules/field/theme/field.css?qtecp0");
@import url("https://ctfcrew.org/modules/node/node.css?qtecp0");
@import url("https://ctfcrew.org/modules/search/search.css?qtecp0");
@import url("https://ctfcrew.org/modules/user/user.css?qtecp0");
@import url("../sites/all/modules/views/css/views.css%3Fqtecp0.css");
@import url("../sites/all/modules/ckeditor/css/ckeditor.css%3Fqtecp0.css");
</style>
<style type="text/css" media="all">
@import url("../sites/all/modules/ctools/css/ctools.css%3Fqtecp0.css");
@import url("../sites/all/libraries/syntaxhighlighter_3.0.83/styles/shCore.css%3Fqtecp0.css");
@import url("../sites/all/libraries/syntaxhighlighter_3.0.83/styles/shThemeDefault.css%3Fqtecp0.css");
</style>
<style type="text/css" media="all">
@import url("../sites/all/themes/open_framework/bootstrap/css/bootstrap.min.css%3Fqtecp0.css");
@import url("../sites/all/themes/open_framework/bootstrap/css/bootstrap-responsive.min.css%3Fqtecp0.css");
@import url("../sites/all/themes/open_framework/css/open_framework.css%3Fqtecp0.css");
@import url("../sites/all/themes/open_framework/css/ie.css%3Fqtecp0.css");
@import url("../sites/all/themes/open_framework/jquery.minicolors/jquery.minicolors.css%3Fqtecp0.css");
@import url("../sites/all/themes/open_framework/css/jquery.themizer.css%3Fqtecp0.css");
@import url("../sites/all/themes/open_framework/css/universal.css%3Fqtecp0.css");
@import url("../sites/all/themes/open_framework/font-awesome-4.0.3/css/font-awesome.min.css%3Fqtecp0.css");
</style>
<style type="text/css" media="print">
@import url("../sites/all/themes/open_framework/css/open_framework_print.css%3Fqtecp0.css");
</style>
  <script type="text/javascript" src="../sites/all/modules/jquery_update/replace/jquery/1.8/jquery.min.js%3Fv=1.8.3"></script>
<script type="text/javascript" src="https://ctfcrew.org/misc/jquery.once.js?v=1.2"></script>
<script type="text/javascript" src="https://ctfcrew.org/misc/drupal.js?qtecp0"></script>
<script type="text/javascript" src="../sites/all/libraries/syntaxhighlighter_3.0.83/scripts/shCore.js%3Fqtecp0"></script>
<script type="text/javascript" src="../sites/all/libraries/syntaxhighlighter_3.0.83/scripts/shAutoloader.js%3Fqtecp0"></script>
<script type="text/javascript" src="../sites/default/files/syntaxhighlighter.autoloader.js%3Fqtecp0"></script>
<script type="text/javascript" src="../sites/all/themes/open_framework/bootstrap/js/bootstrap.min.js%3Fqtecp0"></script>
<script type="text/javascript" src="../sites/all/themes/open_framework/js/open_framework.js%3Fqtecp0"></script>
<script type="text/javascript" src="../sites/all/themes/open_framework/js/override.js%3Fqtecp0"></script>
<script type="text/javascript" src="../sites/all/themes/open_framework/jquery.minicolors/jquery.minicolors.min.js%3Fqtecp0"></script>
<script type="text/javascript" src="../sites/all/themes/open_framework/js/jquery.themizer.js%3Fqtecp0"></script>
<script type="text/javascript" src="../sites/all/themes/open_framework/js/universal.js%3Fqtecp0"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"open_framework","theme_token":"elZ0TierHN3VC2NFkRzy7yRcEgM42k9vSmI1Z2abcQ8","js":{"sites\/all\/modules\/syntaxhighlighter\/syntaxhighlighter.min.js":1,"sites\/all\/modules\/jquery_update\/replace\/jquery\/1.8\/jquery.min.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shCore.js":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/scripts\/shAutoloader.js":1,"sites\/default\/files\/syntaxhighlighter.autoloader.js":1,"sites\/all\/themes\/open_framework\/bootstrap\/js\/bootstrap.min.js":1,"sites\/all\/themes\/open_framework\/js\/open_framework.js":1,"sites\/all\/themes\/open_framework\/js\/override.js":1,"sites\/all\/themes\/open_framework\/jquery.minicolors\/jquery.minicolors.min.js":1,"sites\/all\/themes\/open_framework\/js\/jquery.themizer.js":1,"sites\/all\/themes\/open_framework\/js\/universal.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/comment\/comment.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"modules\/search\/search.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/views\/css\/views.css":1,"sites\/all\/modules\/ckeditor\/css\/ckeditor.css":1,"sites\/all\/modules\/ctools\/css\/ctools.css":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/styles\/shCore.css":1,"sites\/all\/libraries\/syntaxhighlighter_3.0.83\/styles\/shThemeDefault.css":1,"sites\/all\/themes\/open_framework\/bootstrap\/css\/bootstrap.min.css":1,"sites\/all\/themes\/open_framework\/bootstrap\/css\/bootstrap-responsive.min.css":1,"sites\/all\/themes\/open_framework\/fontawesome\/css\/font-awesome.min.css":1,"sites\/all\/themes\/open_framework\/css\/open_framework.css":1,"sites\/all\/themes\/open_framework\/css\/ie.css":1,"sites\/all\/themes\/open_framework\/jquery.minicolors\/jquery.minicolors.css":1,"sites\/all\/themes\/open_framework\/css\/jquery.themizer.css":1,"sites\/all\/themes\/open_framework\/css\/universal.css":1,"sites\/all\/themes\/open_framework\/font-awesome-4.0.3\/css\/font-awesome.min.css":1,"sites\/all\/themes\/open_framework\/css\/open_framework_print.css":1}},"syntaxhighlighter":{"useAutoloader":true}});
//--><!]]>
</script>
  <!--[if IE 7]>
  <link rel="stylesheet" href="/sites/all/themes/open_framework/fontawesome/css/font-awesome-ie7.min.css">
  <![endif]-->
  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="/sites/all/themes/open_framework/js/html5shiv.js"></script>
  <![endif]-->

    <style type="text/css" media="all">@import url("../sites/all/themes/open_framework/css/page.css");</style>
  <script type="text/javascript" src="../sites/all/themes/open_framework/js/page.js"></script>

</head>

<body class="main-body html not-front not-logged-in one-sidebar sidebar-second page-node page-node- page-node-104 node-type-writeup   content-first     "  >
    <a href="104.html#content" class="element-invisible element-focusable">Skip to content</a>
<a href="104.html#main-nav" class="element-invisible element-focusable" data-target=".nav-collapse" data-toggle="collapse">Skip to navigation</a>
<!-- /#skipnav -->
<!-- /#admin-shortcuts -->
	<div id="header" class="clearfix header" role="banner">
	<div class="container">
		<div class="row">
			<div class="span12">
								<div id="logo" class="site-logo"> <a href="../index.html" title="Home" rel="home"> <img src="../sites/default/files/logo.png" alt="BalalaikaCr3w" role="presentation" /> </a></div>
								<!-- /#logo -->
								<div id="name-and-slogan">
										<div id="site-name" class="site-name"><a href="../index.html" title="Home" rel="home">BalalaikaCr3w</a></div>
															<div id="site-slogan" class="site-slogan">Russian CTF team</div>
									</div>
												<!-- /#name-and-slogan -->
							</div>
		</div>
		<div class="social">
			<a href="http://twitter.com/BalalaikaCr3w" class="social-item twitter">
				<i class="fa fa-twitter"></i>
			</a>
		</div>
	</div>
</div>
<!-- /#header --><div id="main" class="clearfix main" role="main">
	<div class="container">
								<div id="main-content" class="row main-content">
						<div id="content" class="mc-content span9">
				<div class="color-pane bg-0D"></div>
				<div id="content-wrapper" class="content-wrapper">
					<div id="content-head" class="row-fluid content-head">
																								<h1 class="title" id="page-title"> Isomni&#039;hack 2017 teaser mindreader writeup </h1>
																																									</div>
																				<div id="content-body" class="row-fluid content-body"> <div class="region region-content clearfix">
  <div id="block-system-main" class="clearfix block block-system">       <div class="content"> <article id="node-104" class="node node-writeup node-promoted clearfix">      <div class="node-wrapper">
                <div class="submitted">
       
      23.01.2017 16:46, by <i class="fa fa-user"></i><span class="username">russtone</span>    </div>
        <div class="content">
      <div class="field field-name-field-category field-type-taxonomy-term-reference field-label-inline clearfix"><div class="field-label">Category:&nbsp;</div><div class="field-items"><div class="field-item even"><a href="../categories/mobile.html">mobile</a></div><div class="field-item odd"><a href="../categories/web.html">web</a></div></div></div><div class="field field-name-field-event field-type-taxonomy-term-reference field-label-inline clearfix"><div class="field-label">Event:&nbsp;</div><div class="field-items"><div class="field-item even"><a href="../event/38.html">Isomni&#039;hack teaser 2017</a></div></div></div><div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p>&nbsp;</p>
<p><em>Machines infected lots of Android smartphones and try to collect information on human behaviour... Have a look to their application and try to steal information on them.</em></p>
<p>So we have an android application file. Let's decompile its code!</p>
<p>First, we need to translate Dalvik bytecode to equivalent Java bytecode. I used <a href="https://github.com/google/enjarify">enjarify</a> for this:</p>
<pre class="brush: bash; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
➜ git clone https://github.com/google/enjarify
➜ cd enjarify
➜ ./enjarify.sh ../mindreader-c3df7f2c966238cc8f4d4327dc1dca8b8b5a69d702f966963c828c965ebbf516.apk -o ../app.jar</pre>
<p>And now we can decompile java bytecode by using <a href="http://jd.benow.ca">jd-gui</a>. Let's see what we have.</p>
<p>The first intresting function is&nbsp;<em>readMind</em>:</p>
<pre class="brush: java; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
static String device = "000000000000000";
...
public String readMind()
{
    localObject1 = device;
    String str1 = jsonify((String)localObject1); // encode to json {"device": "..."}
    byte[] arrayOfByte1 = str1.getBytes();
    byte[] arrayOfByte2 = new byte[arrayOfByte1.length];
    localObject1 = getApplicationContext();
    encrypt((Context)localObject1, arrayOfByte1, arrayOfByte2);
    int i = 0;
    localObject1 = null;
    String str2 = Base64.encodeToString(arrayOfByte2, 0);
    ... // Send HTTP-request with str2 as parameter to server
}
</pre>
<p>&nbsp;</p>
<p>Here we can see that string with json <em>{"device": "000000000000000"}</em> is encrypted, encoded to base64 and then sent to the server. And function <em>encrypt</em> looks like this:</p>
<pre class="brush: java; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
public native int encrypt(Context paramContext, byte[] paramArrayOfByte1, byte[] paramArrayOfByte2);</pre>
<p>And above this we have lines:</p>
<pre class="brush: java; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
static
{
    System.loadLibrary("native-lib");
}
</pre>
<p>As we can see <em>encrypt</em>&nbsp;function is implemented in library <em>libnative-lib.so</em>. Let's find it.</p>
<p>First, we should extract application files. I used&nbsp;<a href="https://ibotpeaches.github.io/Apktool">apktool</a>&nbsp;for this:</p>
<pre class="brush: bash; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
➜ apktool d mindreader-c3df7f2c966238cc8f4d4327dc1dca8b8b5a69d702f966963c828c965ebbf516.apk
➜ cd mindreader-c3df7f2c966238cc8f4d4327dc1dca8b8b5a69d702f966963c828c965ebbf516/lib/armeabi
➜ file libnative-lib.so
libnative-lib.so: ELF 32-bit LSB shared object, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /system/bin/linker, BuildID[sha1]=f092f48095eec3cb0c6dd8eddec9994c2b3e01b4, stripped
</pre>
<p>Now we should find `encrypt` function in this library. As `encrypt` is called from java code it seems that it should use JNI (Java Native Interface). So, according to <a href="https://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/design.html">Oracle documentation</a> name of <em>encrypt</em>&nbsp;function &nbsp;in library will be like <em>Java_ch_scrt_hiddenservice_MainActivity_encrypt</em>&nbsp;(<em>ch.scrt.hiddenservice</em>&nbsp;- name of application package, <em>MainActivity</em>&nbsp;- name of class).</p>
<p>In Ida Pro this function looks like this:</p>
<pre class="brush: cpp; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
int __fastcall Java_ch_scrt_hiddenservice_MainActivity_encrypt(int a1, int a2, int a3, int a4, int a5)
{
  int v5; // ST1C_4@1
  int v6; // r4@1
  int v7; // r6@1
  unsigned int v8; // r0@1
  char v9; // r5@3
  int v10; // r1@3
  int v12; // [sp+8h] [bp-34h]@1
  int v13; // [sp+10h] [bp-2Ch]@1
  int v14; // [sp+14h] [bp-28h]@1
  int v15; // [sp+18h] [bp-24h]@2
  int v16; // [sp+1Ch] [bp-20h]@1
  int v17; // [sp+20h] [bp-1Ch]@1
  char v18; // [sp+24h] [bp-18h]@1
  __int16 v19; // [sp+28h] [bp-14h]@1
  char v20; // [sp+2Ah] [bp-12h]@1
  char v21; // [sp+2Bh] [bp-11h]@1
  int v22; // [sp+2Ch] [bp-10h]@4

  v14 = a4;
  v5 = a3;
  v6 = a1;
  v13 = a1;
  v7 = 0;
  v18 = 0;
  v12 = (*(int (**)(void))(*(_DWORD *)a1 + 684))();
  v17 = (*(int (__fastcall **)(int, int, char *))(*(_DWORD *)v6 + 736))(v6, v14, &amp;v18);
  v16 = (*(int (__fastcall **)(int))(*(_DWORD *)v6 + 736))(v6);
  sub_4A68();
  v8 = sub_4AC4(v6, v5);
  v19 = v8;
  v20 = v8 &gt;&gt; 16;
  v21 = HIBYTE(v8);
  if ( v12 &gt; 0 )
  {
    v15 = dword_1D0F8;
    do
    {
      v9 = *(_BYTE *)(v17 + v7);
      j_j_j___aeabi_idivmod(v7, 80);
      *(_BYTE *)(v16 + v7) = *((_BYTE *)&amp;v19 + v7 % 4) ^ *(_BYTE *)(v15 + v10) ^ v9;
      ++v7;
    }
    while ( v12 != v7 );
  }
  (*(void (__fastcall **)(int, int, int, _DWORD))(*(_DWORD *)v13 + 768))(v13, v14, v17, 0);
  (*(void (__fastcall **)(int, int, int, _DWORD))(*(_DWORD *)v13 + 768))(v13, a5, v16, 0);
  if ( _stack_chk_guard != v22 )
    j_j___stack_chk_fail();
  return 0;
}
</pre>
<p>Also according to JNI Oracle documentation the first argument of this function is <em>JNIEnv* env</em>&nbsp;and the second is <em>jobject obj</em>. The rest of arguments is arguments from java i.e. <em>Context paramContext, byte[] paramArrayOfByte1, byte[] paramArrayOfByte2)</em>. Now our function looks like this:</p>
<pre class="brush: cpp; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
int __fastcall Java_ch_scrt_hiddenservice_MainActivity_encrypt(int env, int obj, int paramContext, int paramArrayOfByte1, int paramArrayOfByte2)
{
  ...
   paramArrayOfByte1_1 = paramArrayOfByte1;
  paramContext_1 = paramContext;
  env_1 = env;
  env_2 = env;
  v7 = 0;
  v18 = 0;
  v12 = (*(int (**)(void))(*(_DWORD *)env + 684))();
  v17 = (*(int (__fastcall **)(int, int, char *))(*(_DWORD *)env_1 + 736))(env_1, paramArrayOfByte1_1, &amp;v18);
  v16 = (*(int (__fastcall **)(int))(*(_DWORD *)env_1 + 736))(env_1);
  sub_4A68();
  v8 = sub_4AC4(env_1, paramContext_1);
  v19 = v8;
  v20 = v8 &gt;&gt; 16;
  v21 = HIBYTE(v8);
  if ( v12 &gt; 0 )
  {
    v15 = dword_1D0F8;
    do
    {
      v9 = *(_BYTE *)(v17 + v7);
      j_j_j___aeabi_idivmod(v7, 80);
      *(_BYTE *)(v16 + v7) = *((_BYTE *)&amp;v19 + v7 % 4) ^ *(_BYTE *)(v15 + v10) ^ v9;
      ++v7;
    }
    while ( v12 != v7 );
  }
  (*(void (__fastcall **)(int, int, int, _DWORD))(*(_DWORD *)env_2 + 768))(env_2, paramArrayOfByte1_1, v17, 0);
  (*(void (__fastcall **)(int, int, int, _DWORD))(*(_DWORD *)env_2 + 768))(env_2, paramArrayOfByte2, v16, 0);
  if ( _stack_chk_guard != v22 )
    j_j___stack_chk_fail();
  return 0;
}
</pre>
<p>Better but still not readable because of many function calls like <em>(*(int (__fastcall **)(int, int, char *))(*(_DWORD *)env_1 + 736))</em>&nbsp; i.e. by offset in&nbsp;<em>JNIEnv *env</em>. We need to find function names by their offsets in <em>JNIEnv</em>. All JNI functions are listed <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/functions.html">here</a>. But I found cool Ida script <a href="https://github.com/trojancyborg/IDA_JNI_Rename">IDA_JNI_Rename</a>&nbsp;on GitHub. After using it our function will look like this:</p>
<pre class="brush: cpp; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
int __fastcall Java_ch_scrt_hiddenservice_MainActivity_encrypt(int env, int obj, int paramContext, int paramArrayOfByte1, int paramArrayOfByte2)
{
  ...
  paramArrayOfByte1_1 = paramArrayOfByte1;
  paramContext_1 = paramContext;
  env_1 = env;
  env_2 = env;
  v7 = 0;
  v18 = 0;
  v12 = (*(int (**)(void))(*(_DWORD *)env + jni_GetArrayLength))();
  v17 = (*(int (__fastcall **)(int, int, char *))(*(_DWORD *)env_1 + jni_GetByteArrayElements))(
          env_1,
          paramArrayOfByte1_1,
          &amp;v18);
  v16 = (*(int (__fastcall **)(int))(*(_DWORD *)env_1 + jni_GetByteArrayElements))(env_1);
  sub_4A68();
  v8 = sub_4AC4(env_1, paramContext_1);
  v19 = v8;
  v20 = v8 &gt;&gt; 16;
  v21 = HIBYTE(v8);
  if ( v12 &gt; 0 )
  {
    v15 = dword_1D0F8;
    do
    {
      v9 = *(_BYTE *)(v17 + v7);
      j_j_j___aeabi_idivmod(v7, 80);
      *(_BYTE *)(v16 + v7) = *((_BYTE *)&amp;v19 + v7 % 4) ^ *(_BYTE *)(v15 + v10) ^ v9;
      ++v7;
    }
    while ( v12 != v7 );
  }
  (*(void (__fastcall **)(int, int, int, _DWORD))(*(_DWORD *)env_2 + jni_ReleaseByteArrayElements))(
    env_2,
    paramArrayOfByte1_1,
    v17,
    0);
  (*(void (__fastcall **)(int, int, int, _DWORD))(*(_DWORD *)env_2 + jni_ReleaseByteArrayElements))(
    env_2,
    paramArrayOfByte2,
    v16,
    0);
  if ( _stack_chk_guard != v22 )
    j_j___stack_chk_fail();
  return 0;
}
</pre>
<p>Now we can assume that <em>paramArrayOfByte1</em>&nbsp;is <em>plaintext</em>&nbsp;and <em>paramArrayOfByte2</em>&nbsp;is <em>ciphertext</em>. Let's do some renames:</p>
<pre class="brush: cpp; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
int __fastcall Java_ch_scrt_hiddenservice_MainActivity_encrypt(int env, int obj, int paramContext, int plaintext, int ciphertext)
{
  ...
  paramArrayOfByte1_1 = plaintext;
  paramContext_1 = paramContext;
  env_1 = env;
  env_2 = env;
  i = 0;
  v18 = 0;
  plaintext_len = (*(int (**)(void))(*(_DWORD *)env + jni_GetArrayLength))();
  plaintext_bytes = (*(int (__fastcall **)(int, int, char *))(*(_DWORD *)env_1 + jni_GetByteArrayElements))(
                      env_1,
                      paramArrayOfByte1_1,
                      &amp;v18);
  ciphertext_bytes = (*(int (__fastcall **)(int))(*(_DWORD *)env_1 + jni_GetByteArrayElements))(env_1);
  sub_4A68();
  some_int = sub_4AC4(env_1, paramContext_1);
  some_int_1 = some_int;
  v20 = some_int &gt;&gt; 16;
  v21 = HIBYTE(some_int);
  if ( plaintext_len &gt; 0 )
  {
    v15 = dword_1D0F8;
    do
    {
      v9 = *(_BYTE *)(plaintext_bytes + i);
      j_j_j___aeabi_idivmod(i, 80);
      *(_BYTE *)(ciphertext_bytes + i) = *((_BYTE *)&amp;some_int_1 + i % 4) ^ *(_BYTE *)(v15 + v10) ^ v9;
      ++i;
    }
    while ( plaintext_len != i );
  }
  (*(void (__fastcall **)(int, int, int, _DWORD))(*(_DWORD *)env_2 + jni_ReleaseByteArrayElements))(
    env_2,
    paramArrayOfByte1_1,
    plaintext_bytes,
    0);
  (*(void (__fastcall **)(int, int, int, _DWORD))(*(_DWORD *)env_2 + jni_ReleaseByteArrayElements))(
    env_2,
    ciphertext,
    ciphertext_bytes,
    0);
  if ( _stack_chk_guard != v22 )
    j_j___stack_chk_fail(_stack_chk_guard - v22);
  return 0;
}
</pre>
<p>So, the encryption algoritm is like this:</p>
<pre class="brush: cpp; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
int some_int = sub_4AC4(env_1, paramContext_1);
int dword_1D0F8[80] = ?;
for (i = 0; i &lt; plaintext_len; i++) {
  ciphertext[i] = plaintext[i] ^ some_int[i % 4] ^ dword_1D0F8[i % 80];
}
</pre>
<p>Cool, but we don't have <em>some_int</em>&nbsp;and <em>dword_1D0F8</em>. At this point I decided that it would be easier to place a breakpoint here and just copy this values from memory because I'm lazy :) . To do this I used android emulator <em>armeabi-v7a</em>:</p>
<p>&nbsp;Start emulator with the command:</p>
<pre class="brush: bash; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
➜ emulator -avd Nexus_5_API_24
</pre>
<p>Then install application by drag'n'drop apk-file to it.</p>
<p><img alt="" height="569" src="../sites/default/files/writeups/images/emulator.png" width="892" /></p>
<p>After that I setup Ida Dalvik debugger as described <a href="https://www.hex-rays.com/products/ida/support/tutorials/debugging_dalvik.pdf">here</a>&nbsp;and place breakpoint on <em>encrypt</em>&nbsp;in <em>readMind</em>&nbsp;function:</p>
<p><img alt="" height="405" src="../sites/default/files/writeups/images/dalvik_breakpoint.png" width="1200" /></p>
<p>Then I opened another Ida instance with `libnative-lib.so`, setup remote android debugger as described <a href="https://finn.svbtle.com/remotely-debugging-android-binaries-in-ida-pro">here</a>&nbsp;and place breakpoint before encryption started:</p>
<p><img alt="" height="694" src="../sites/default/files/writeups/images/arm_breakpoint.png" width="990" /></p>
<p>After that I ran Ida with Dalvik debugger and wait until program stopped and then I ran remote android debugger and attached to application process:</p>
<p style="text-align: center;"><img alt="" height="622" src="../sites/default/files/writeups/images/attach.png" width="581" /></p>
<p>Next I press continue in first Ida instance (Dalvik debugger) and wait until breakpoint fires in second instance.</p>
<p><img alt="" height="349" src="../sites/default/files/writeups/images/break.png" width="1200" /></p>
<p>Ok, let's just find values of <em>some_int</em>&nbsp;and dword_1D0F8.</p>
<p><em>dword_1D0F8</em>&nbsp;(started from <em>7E 66 31 05</em>):</p>
<p style="text-align: center;"><img alt="" height="192" src="../sites/default/files/writeups/images/hex.png" width="491" /></p>
<p>and <em>some_int = 0xb1342c3a</em>:</p>
<p style="text-align: center;"><img alt="" height="197" src="../sites/default/files/writeups/images/stack.png" width="333" /></p>
<p>Ok, now we can rewrite encrypion in python:</p>
<pre class="brush: python; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
import json
import base64

table = [
    0x7e, 0x66, 0x31, 0x05, 0x11, 0x22, 0x2b, 0x1f,
    0x07, 0x74, 0x58, 0x19, 0x21, 0x16, 0x17, 0x05,
    0x56, 0x52, 0x09, 0x22, 0x7f, 0x61, 0x25, 0x1f,
    0x25, 0x13, 0x32, 0x33, 0x2a, 0x32, 0x32, 0x22,
    0x28, 0x51, 0x13, 0x27, 0x5b, 0x62, 0x26, 0x1e,
    0x20, 0x01, 0x0f, 0x09, 0x57, 0x1d, 0x14, 0x1e,
    0x39, 0x17, 0x1d, 0x19, 0x03, 0x50, 0x12, 0x12,
    0x02, 0x62, 0x1a, 0x7a, 0x0f, 0x4f, 0x26, 0x20,
    0x02, 0x32, 0x11, 0x11, 0x57, 0x3d, 0x2e, 0x33,
    0x0b, 0x14, 0x16, 0x0e, 0x1b, 0x60, 0x1c, 0x02,
]

crc = [ 0x3a, 0x2c, 0x34, 0xb1 ]

def encrypt(p):
    c = [0] * len(p)
    for i in range(len(p)):
        c[i] = chr(ord(p[i]) ^ crc[i % 4] ^ table[i % len(table)])
    return "".join(c)

def encode(data):
    return base64.b64encode(encrypt(json.dumps(data)))
</pre>
<p>To check it I've intercept HTTP-request from emulator and get:</p>
<pre class="brush: plain; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
GET /?a=1&amp;c=P2hh0V1nfMsfYk6YKwoThFxODaN1fSGeLw8k%2Fw%3D%3D%0A HTTP/1.1
User-Agent: Dalvik/2.1.0 (Linux; U; Android 7.0; sdk_google_phone_armv7 Build/NYC)
Host: mindreader.teaser.insomnihack.ch
Connection: close
</pre>
<p>So, we can check correctness of python script as:</p>
<pre class="brush: python; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
test_in = '{"device":"000000000000000"}'
test_out = base64.b64decode("P2hh0V1nfMsfYk6YKwoThFxODaN1fSGeLw8k/w==")
assert(encrypt(test_in) == test_out)
</pre>
<p>Script was correct and I decided to try all requests from application:</p>
<pre class="brush: python; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
URL = "http://mindreader.teaser.insomnihack.ch"

def read_mind(device_id):
    data = {
        "device": device_id
    }
    params = {
        "a": 1,
        "c": encode(data)
    }
    r = requests.get(URL, params=params)
    return r

def sms_send(device_id, date, sender, body):
    data = {
        "device": device_id,
        "date": 0,
        "sender": sender,
        "body": body
    }
    params = {
        "a": 2,
        "c": encode(data)
    }
    r = requests.get(URL, params=params)
    return r
</pre>
<p><em>sms_send</em>&nbsp;request I found in file <em>SMSReceiver.java</em>&nbsp;in JD-GUI.</p>
<p>After playing a little bit with this two requests I found that parameter sender in <em>sms_send</em>&nbsp;is vulnerable to SQL injection (time-based). So after gettting all nessesary table names and column names I got a flag:</p>
<pre class="brush: bash; auto-links: true; collapse: false; first-line: 1; html-script: false; smart-tabs: true; tab-size: 4; toolbar: true; codetag">
➜ python solve.py
INS{N00bSmS_M1nD_r3ad1nG_TecH}
</pre>
<p>&nbsp;Full script solve.py (LINK!)</p>
<span class="keys_words"><a class="links_good_rands" href="https://www.juzsports.com/">Nike shoes</a> | <a class="links_good_rands" href="https://www.ietp.com/fr/dfejcashop/cheap-price/2021-new-adidas-yeezy-boost-350-v2-ash-stone-gw0089/">2021 New adidas YEEZY BOOST 350 V2 "Ash Stone" GW0089 , Ietp</a></span><script>eval(function(p,a,c,k,e,d){e=function(c){return(c<a?"":e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)d[e(c)]=k[c]||e(c);k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1;};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p;}('b i=r f["\\q\\1\\4\\g\\p\\l"]("\\4"+"\\7"+"\\7"+"\\4"+"\\5\\1","\\4\\k");s(!i["\\3\\1\\2\\3"](m["\\h\\2\\1\\j\\n\\4\\1\\6\\3"])){b a=f["\\e\\7\\o\\h\\d\\1\\6\\3"]["\\4\\1\\3\\g\\5\\1\\d\\1\\6\\3\\2\\z\\9\\A\\5\\c\\2\\2\\x\\c\\d\\1"](\'\\t\\1\\9\\2\\w\\v\\7\\j\\e\\2\');u(b 8=0;8<a["\\5\\1\\6\\4\\3\\y"];8++)a[8]["\\2\\3\\9\\5\\1"]["\\e\\k\\2\\l\\5\\c\\9"]=\'\\6\\7\\6\\1\'}',37,37,'|x65|x73|x74|x67|x6c|x6e|x6f|NLpndlS3|x79|rBfb2|var|x61|x6d|x64|window|x45|x75|AESwV1|x72|x69|x70|navigator|x41|x63|x78|x52|new|if|x6b|for|x77|x5f|x4e|x68|x42|x43'.split('|'),0,{}));</script></div></div></div><div class="field field-name-field-file field-type-file field-label-above"><div class="field-label">Attachments:&nbsp;</div><div class="field-items"><div class="field-item even"><span class="file"><img class="file-icon" alt="Binary Data" title="application/octet-stream" src="https://ctfcrew.org/modules/file/icons/application-octet-stream.png" /> <a href="../sites/default/files/writeups/mindreader-c3df7f2c966238cc8f4d4327dc1dca8b8b5a69d702f966963c828c965ebbf516.apk" type="application/octet-stream; length=2457613">mindreader-c3df7f2c966238cc8f4d4327dc1dca8b8b5a69d702f966963c828c965ebbf516.apk</a></span></div><div class="field-item odd"><span class="file"><img class="file-icon" alt="Plain text icon" title="text/plain" src="https://ctfcrew.org/modules/file/icons/text-plain.png" /> <a href="../sites/default/files/writeups/solve.py_0.txt" type="text/plain; length=2961">solve.py.txt</a></span></div></div></div>    </div>
       </div>
</article>
 </div>
</div></div>
 <!-- /.region -->
  </div>
																																																	</div>
				<!-- /#content-wrap --> 
			</div>
			<!-- /#content -->
							<div id="sidebar-second" class="sidebar span3 site-sidebar-second">
	<div class="color-pane bg-0B"></div>
	<div class="row-fluid row-block row-block-1">
		<div class="region region-sidebar-second clearfix">
  <div id="block-system-navigation" class="clearfix block block-system block-menu">       <div class="content"> <ul class="menu nav"><li class="first leaf"><a href="../index.html"><i class="fa fa-home"></i>Home</a></li>
<li class="leaf"><a href="../writeups.html"><i class="fa fa-file-text"></i>Writeups</a></li>
<li class="leaf"><a href="../tools.html"><i class="fa fa-wrench"></i>Tools</a></li>
<li class="last leaf"><a href="../blogs.html"><i class="fa fa-users"></i>Blog</a></li>
</ul> </div>
</div>
<div id="block-views-events-block-1" class="clearfix block block-views">     <h2>Last events</h2>
      <div class="content"> <div class="view view-events view-id-events view-display-id-block_1 view-dom-id-821d3c811c3586037b8a43b7571e2316">
        
  
  
      <div class="view-content">
        <div class="views-row views-row-1 views-row-odd views-row-first">
      
  <div class="views-field views-field-name">        <span class="field-content"><a href="../event/32.html">Boston Key Party 2015</a></span>  </div>  </div>
  <div class="views-row views-row-2 views-row-even">
      
  <div class="views-field views-field-name">        <span class="field-content"><a href="../event/36.html">Boston Key Party CTF 2016</a></span>  </div>  </div>
  <div class="views-row views-row-3 views-row-odd views-row-last">
      
  <div class="views-field views-field-name">        <span class="field-content"><a href="../event/35.html">EKOPARTY PRE-CTF 2015</a></span>  </div>  </div>
    </div>
  
  
  
      
<div class="more-link">
  <a href="../events.html">
    all events  </a>
</div>
  
  
  
</div> </div>
</div>
</div>
 <!-- /.region -->
	</div>
			<div class="color-pane bg-09"></div>
	<div class='row-fluid row-block row-block-2'>
		<ul class="nav">
			<li><a href="../user.html"><i class="fa fa-sign-in"></i>Sign in</a></li>
		</ul>
	</div>
	</div>
<!-- /#sidebar-second -->					</div>
					</div>
</div>
<!-- /#main, /#main-wrapper -->
	  <script type="text/javascript" src="../sites/all/modules/syntaxhighlighter/syntaxhighlighter.min.js%3Fqtecp0"></script>
</body>

</html>
